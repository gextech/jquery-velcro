// Generated by CoffeeScript 1.10.0
(function() {
  var calculate_all_stickes, check_if_can_bottom, check_if_can_stick, check_if_can_unbottom, check_if_can_unstick, check_if_fit, height, initialize_sticky, placeholder, refresh_all_stickies, stack, stickies, update_sticky, win;

  win = $(window);

  height = win.height();

  stack = {};

  stickies = [];

  placeholder = function(node) {
    var fixed;
    fixed = {
      width: node.width,
      height: node.orig_height,
      float: node.el.css('float'),
      position: node.el.css('position'),
      verticalAlign: node.el.css('vertical-align')
    };
    return $('<div/>').css(fixed).css('display', 'none').insertBefore(node.el);
  };

  update_sticky = function(node) {
    var fixed_bottom, parent_height, parent_top;
    if (!stack[node.data.group]) {
      stack[node.data.group] = node.data.stack !== false ? stack[node.data.stack || 'all'] || 0 : 0;
    }
    node.offset_top = node.data.stack !== false ? stack[node.data.group] : 0;
    node.orig_height = node.el.outerHeight();
    if (!node.isFloat) {
      stack[node.data.group] += node.orig_height;
    }
    if (node.isFixed) {
      return;
    }
    parent_top = node.parent.offset().top;
    parent_height = node.parent.outerHeight();
    node.offset = node.el.offset();
    node.height = node.orig_height;
    node.width = node.el.outerWidth();
    node.position = node.el.position();
    node.passing_top = node.offset.top - node.offset_top;
    node.passing_height = node.orig_height + node.offset_top;
    node.passing_bottom = parent_top + parent_height;
    if (node.data.fit) {
      fixed_bottom = node.offset.top + node.orig_height;
      node.fixed_bottom = node.passing_bottom - fixed_bottom;
      node.passing_bottom = fixed_bottom;
      if (node.height >= height) {
        node.height = height - node.offset_top;
        node.passing_height = height;
      }
    }
    return true;
  };

  initialize_sticky = function(node, params) {
    var data, parent;
    if (params == null) {
      params = {};
    }
    data = $.extend({}, params, node.data('sticky') || {});
    data.group || (data.group = 'all');
    parent = data.parent ? node.closest(data.parent) : node.parent();
    node = {
      el: node,
      data: data,
      parent: parent,
      offset: node.offset(),
      position: node.position(),
      display: node.css('display'),
      isFloat: node.css('float') !== 'none',
      isFixed: data.fixed || (node.css('position') === 'fixed')
    };
    if (update_sticky(node)) {
      node.placeholder = placeholder(node);
      return stickies.push(node);
    }
  };

  check_if_fit = function(sticky, scroll_top) {
    var fitted_top;
    if (sticky.data.fit) {
      fitted_top = height + scroll_top - sticky.offset_top;
      if (fitted_top >= sticky.passing_top) {
        if (!sticky.el.hasClass('fit')) {
          sticky.el.addClass('fit');
        }
        return sticky.el.css('height', Math.min(fitted_top - sticky.passing_top, sticky.height));
      } else {
        if (sticky.el.hasClass('fit')) {
          return sticky.el.removeClass('fit');
        }
      }
    }
  };

  check_if_can_stick = function(sticky, scroll_top) {
    if (!sticky.el.hasClass('stuck')) {
      if (sticky.placeholder) {
        sticky.placeholder.css('display', sticky.display);
      }
      return sticky.el.addClass('stuck').css({
        position: 'fixed',
        width: sticky.width,
        height: sticky.height,
        left: sticky.offset.left,
        top: sticky.offset_top,
        bottom: sticky.data.fit ? 0 : void 0
      });
    }
  };

  check_if_can_unstick = function(sticky, scroll_top) {
    if (sticky.el.hasClass('stuck')) {
      if (sticky.placeholder) {
        sticky.placeholder.css('display', 'none');
      }
      return sticky.el.removeClass('fit stuck bottom').attr('style', '');
    }
  };

  check_if_can_bottom = function(sticky) {
    if (!sticky.el.hasClass('bottom')) {
      return sticky.el.addClass('bottom').css({
        position: 'absolute',
        left: sticky.position.left,
        bottom: sticky.fixed_bottom || 0,
        top: 'auto',
        height: sticky.data.fit ? sticky.height : void 0
      });
    }
  };

  check_if_can_unbottom = function(sticky) {
    if (sticky.el.hasClass('bottom')) {
      return sticky.el.removeClass('bottom').css({
        position: 'fixed',
        left: sticky.offset.left,
        top: sticky.offset_top
      });
    }
  };

  calculate_all_stickes = function() {
    var scroll_top;
    scroll_top = win.scrollTop();
    return stickies.forEach(function(sticky) {
      if (scroll_top <= sticky.passing_top) {
        check_if_can_unstick(sticky, scroll_top);
      } else {
        check_if_can_stick(sticky, scroll_top);
        if ((scroll_top + sticky.passing_height) >= sticky.passing_bottom) {
          check_if_can_bottom(sticky);
        } else {
          check_if_can_unbottom(sticky);
        }
      }
      return check_if_fit(sticky, scroll_top);
    });
  };

  refresh_all_stickies = function(destroy) {
    stack = {};
    return stickies = stickies.filter(function(sticky) {
      sticky.el.attr('style', '').removeClass('fit stuck bottom');
      sticky.placeholder.remove();
      if (!destroy) {
        update_sticky(sticky);
        sticky.placeholder = placeholder(sticky);
        return true;
      }
      return false;
    });
  };

  win.on('touchmove', function() {
    return calculate_all_stickes();
  });

  win.on('scroll', function() {
    return calculate_all_stickes();
  });

  win.on('resize', function() {
    height = win.height();
    refresh_all_stickies();
    return calculate_all_stickes();
  });

  $.velcro = function(selector, params) {
    if (params == null) {
      params = {};
    }
    if (selector === 'destroy') {
      refresh_all_stickies(true);
    } else if (selector === 'update') {
      refresh_all_stickies();
    } else {
      $(selector).each(function() {
        return initialize_sticky($(this), params);
      });
    }
    return calculate_all_stickes();
  };

}).call(this);
